<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Dashboard - Smart Appointments</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gray-50">
  <nav class="bg-white shadow-md sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="../index.html" class="flex items-center space-x-2">
        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
          <span class="text-white font-bold">üìÖ</span>
        </div>
        <h1 class="text-2xl font-bold text-gray-800">Smart Appointments</h1>
      </a>
      <div class="flex items-center gap-4">
        <span class="text-gray-600" id="userName"></span>
        <a href="patient-book.html" class="btn btn-primary btn-sm">
          + Book Appointment
        </a>
        <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8 text-gray-800">üìä My Appointments</h1>

    <div id="errorAlert"></div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="card p-6">
        <div class="text-4xl mb-2">üìÖ</div>
        <div class="text-gray-600">Total Appointments</div>
        <div class="text-3xl font-bold text-blue-600" id="totalCount">0</div>
      </div>
      <div class="card p-6">
        <div class="text-4xl mb-2">‚è≥</div>
        <div class="text-gray-600">Pending Confirmation</div>
        <div class="text-3xl font-bold text-yellow-600" id="pendingCount">0</div>
      </div>
      <div class="card p-6">
        <div class="text-4xl mb-2">‚úÖ</div>
        <div class="text-gray-600">Confirmed</div>
        <div class="text-3xl font-bold text-green-600" id="confirmedCount">0</div>
      </div>
    </div>

    <!-- Upcoming Appointments -->
    <div class="card mb-8">
      <div class="card-header">
        <h2 class="text-2xl font-bold">üìÖ Upcoming Appointments</h2>
      </div>
      <div class="card-body">
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th>Provider</th>
                <th>Date & Time</th>
                <th>Service</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="upcomingTable">
              <tr>
                <td colspan="5" class="text-center text-gray-500">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Past Appointments -->
    <div class="card">
      <div class="card-header">
        <h2 class="text-2xl font-bold">üìã Past Appointments</h2>
      </div>
      <div class="card-body">
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th>Provider</th>
                <th>Date & Time</th>
                <th>Service</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="pastTable">
              <tr>
                <td colspan="4" class="text-center text-gray-500">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Modal -->
  <div id="cancelModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Cancel Appointment?</h3>
        <button class="modal-close" onclick="closeModal('cancelModal')">√ó</button>
      </div>
      <div class="modal-body">
        <p id="cancelMessage" class="text-gray-700 mb-4"></p>
        <div class="alert alert-warning">
          ‚ö†Ô∏è This action cannot be undone. The appointment slot will be released.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('cancelModal')">Keep Appointment</button>
        <button class="btn btn-danger" id="cancelBtn">Cancel Appointment</button>
      </div>
    </div>
  </div>

  <script src="../js/auth.js?v=1.1"></script>
  <script src="../js/patient.js?v=1.1"></script>
  <script>
    // Check authentication
    requireAuth();

    if (!isPatient()) {
      window.location.href = 'login.html?error=patient_only';
    }

    const userName = localStorage.getItem('userName');
    document.getElementById('userName').textContent = `üë§ ${userName}`;

    // Modal functions
    function openModal(id) {
      document.getElementById(id).style.display = 'flex';
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    


    // Load appointments
    async function loadAppointments() {
      try {
        const appointments = await getPatientAppointments();
        const now = new Date();

        const upcoming = appointments.filter((a) => new Date(a.start) > now);
        const past = appointments.filter((a) => new Date(a.start) <= now);

        const pending = appointments.filter((a) => a.status === 'pending').length;
        const confirmed = appointments.filter((a) => a.status === 'confirmed').length;

        // Update stats
        document.getElementById('totalCount').textContent = appointments.length;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('confirmedCount').textContent = confirmed;

        // Upcoming table
        const upcomingTable = document.getElementById('upcomingTable');
        if (upcoming.length === 0) {
          upcomingTable.innerHTML =
            '<tr><td colspan="5" class="text-center text-gray-500">No upcoming appointments. <a href="patient-book.html" class="text-blue-600 hover:underline">Book one now!</a></td></tr>';
        } else {
          upcomingTable.innerHTML = upcoming
            .map((apt) => {
              const start = new Date(apt.start).toLocaleString();
              const statusClass = apt.status === 'confirmed' ? 'badge-confirmed' : 'badge-pending';
              const providerName = apt.providerId && apt.providerId.name ? apt.providerId.name : 'Unknown Provider';
              return `
              <tr>
                <td>${providerName}</td>
                <td>${start}</td>
                <td>${apt.service?.name || 'Service'}</td>
                <td><span class="badge ${statusClass}">${apt.status}</span></td>
                <td>
                  ${apt.status !== 'cancelled' ? `<button class="btn btn-danger btn-sm" onclick="showCancel('${apt._id}', '${providerName}')">Cancel</button>` : '‚Äî'}
                </td>
              </tr>
            `;
            })
            .join('');
        }

        // Past table
        const pastTable = document.getElementById('pastTable');
        if (past.length === 0) {
          pastTable.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">No past appointments</td></tr>';
        } else {
          pastTable.innerHTML = past
            .map((apt) => {
              const start = new Date(apt.start).toLocaleString();
              const statusClass =
                apt.status === 'completed'
                  ? 'badge-success'
                  : apt.status === 'cancelled'
                    ? 'badge-danger'
                    : 'badge-confirmed';
              const providerName = apt.providerId && apt.providerId.name ? apt.providerId.name : 'Unknown Provider';
              return `
              <tr>
                <td>${providerName}</td>
                <td>${start}</td>
                <td>${apt.service?.name || 'Service'}</td>
                <td><span class="badge ${statusClass}">${apt.status}</span></td>
              </tr>
            `;
            })
            .join('');
        }
      } catch (error) {
        console.error('Error loading appointments:', error);
        document.getElementById('errorAlert').innerHTML =
          '<div class="alert alert-error">‚ùå Error loading appointments</div>';
      }
    }

    // Show cancel modal
    function showCancel(appointmentId, providerName) {
      const modal = document.getElementById('cancelModal');
      document.getElementById('cancelMessage').textContent = `Cancel your appointment with ${providerName}?`;

      const btn = document.getElementById('cancelBtn');
      btn.onclick = async () => {
        btn.disabled = true;
        try {
          await cancelAppointment(appointmentId);
          closeModal('cancelModal');
          loadAppointments();
          document.getElementById('errorAlert').innerHTML =
            '<div class="alert alert-success">‚úÖ Appointment cancelled</div>';
        } catch (error) {
          document.getElementById('errorAlert').innerHTML =
            `<div class="alert alert-error">‚ùå ${error.message}</div>`;
        } finally {
          btn.disabled = false;
        }
      };

      openModal('cancelModal');
    }

    // Initialize
    loadAppointments();

    // Reload every 10 seconds
    setInterval(loadAppointments, 10000);
  </script>
</body>
</html>
